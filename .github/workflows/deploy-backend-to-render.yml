name: Deploy Backend to Render

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trigger Render deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_SERVICE_ID" ]; then
            echo "Missing RENDER_API_KEY or RENDER_SERVICE_ID. Add them to repository secrets.";
            exit 1;
          fi

          echo "Creating deploy on Render for service $RENDER_SERVICE_ID..."
          resp=$(curl -s -X POST \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{}' \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys")

          echo "Render response:"
          echo "$resp"

          deploy_id=$(echo "$resp" | jq -r '.id // empty')
          if [ -z "$deploy_id" ]; then
            echo "Failed to start deploy. See response above.";
            exit 1;
          fi

          echo "Started deploy: $deploy_id"
          echo "Polling deploy status (this may take a few minutes)..."

          # Poll deploy status until it reaches a terminal state
          while true; do
            status_resp=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys/$deploy_id")
            state=$(echo "$status_resp" | jq -r '.state // empty')
            echo "Deploy state: $state"
            if [ "$state" = "live" ]; then
              echo "Deploy succeeded.";
              break;
            elif [ "$state" = "failed" ]; then
              echo "Deploy failed.";
              echo "$status_resp";
              exit 1;
            fi
            sleep 5
          done
